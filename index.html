<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Or√ßamentos Eleva Print</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 950px; margin: 20px auto; padding: 20px; background: #f9f9f9; color: #333; }
    h2 { text-align: center; color: #00B4D8; margin-bottom: 20px; position: relative; }
    #logo { position: absolute; top: 0; left: 20px; height: 60px; }
    .form-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: 600; color: #333; }
    input, textarea, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    button { margin-top: 15px; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: .3s; }
    .btn-add { background: #D0006F; color: #fff; width: 100%; }
    .btn-add:hover { background: #a80055; }
    .btn-service { background: #FFD500; color: #333; margin-top: 8px; }
    .btn-service:hover { background: #e6c200; }
    .orcamento-card { background: #fff; border-left: 6px solid #FFD500; padding: 15px; margin: 15px 0; border-radius: 8px; box-shadow: 0 3px 6px rgba(0,0,0,0.08); }
    .orcamento-card p { margin: 5px 0; }
    .btn-pdf { background: #00B4D8; color: #fff; margin-right: 10px; }
    .btn-del { background: #e74c3c; color: #fff; }
    .btn-pdf:hover { background: #0088a8; }
    .btn-del:hover { background: #c0392b; }
    h3 { color: #D0006F; }
    #taxaEntregaField { display: none; }
    .servico-group { display: grid; grid-template-columns: 2fr 0.6fr 1fr 1fr; gap: 8px; margin-bottom: 10px; align-items: center; }
    .servico-group input { margin-top: 0; }
    .right { text-align: right; }
  </style>
</head>
<body>
  <!-- LOGO -->
  <img id="logo" src="logo.png" alt="Logo">

  <h2>üìë Or√ßamentos Eleva Print</h2>

  <div class="form-card">
    <label>N¬∞ do Or√ßamento:</label>
    <input type="text" id="numeroOrcamento" />

    <label>Cliente:</label>
    <input type="text" id="cliente" />

    <label>Contato (WhatsApp/Telefone):</label>
    <input type="text" id="contato" maxlength="15" oninput="formatarTelefone(this)" />

    <h4>üìç Endere√ßo</h4>
    <label>Rua:</label>
    <input type="text" id="rua" />
    <label>Bairro:</label>
    <input type="text" id="bairro" />
    <label>N√∫mero:</label>
    <input type="number" id="numero" />
    <label>Ponto de Refer√™ncia:</label>
    <input type="text" id="referencia" />

    <label>CPF ou CNPJ:</label>
    <input type="text" id="documento" oninput="formatarDocumento(this)" />

    <label>Servi√ßos/Produtos:</label>
    <div id="servicos">
      <div class="servico-group">
        <input type="text" class="descricao" placeholder="Descri√ß√£o" />
        <input type="number" class="quantidade" placeholder="Qtd" min="1" value="1" oninput="atualizarTotais()" />
        <input type="number" class="valorUnitario" placeholder="Valor Unit√°rio (R$)" min="0" step="0.01" oninput="atualizarTotais()" />
        <input type="text" class="totalItem right" placeholder="Total (R$)" readonly value="R$ 0,00" />
      </div>
    </div>
    <button type="button" class="btn-service" onclick="adicionarServico()">‚ûï Adicionar Servi√ßo</button>

    <label>Descri√ß√£o Adicional:</label>
    <textarea id="descricao"></textarea>

    <label>Prazo (dias √∫teis):</label>
    <input type="number" id="prazo" />

    <label>Entrega ou Retirada:</label>
    <select id="entregaRetirada" onchange="toggleTaxaEntrega()">
      <option value="Retirada">Retirada</option>
      <option value="Entrega">Entrega</option>
    </select>

    <div id="taxaEntregaField">
      <label>Taxa de Entrega (R$):</label>
      <input type="number" id="taxaEntrega" min="0" step="0.01" value="0" oninput="atualizarTotais()" />
    </div>

    <label><b>Total Geral (R$):</b></label>
    <input type="text" id="valorTotal" class="right" readonly value="R$ 0,00" />

    <button class="btn-add" onclick="salvarOrcamento()">Salvar Or√ßamento</button>
  </div>

  <h3>üìÇ Or√ßamentos Salvos</h3>
  <div id="listaOrcamentos"></div>

  <script>
    const { jsPDF } = window.jspdf;

    // ---------- Utilidades ----------
    function brl(n) {
      return (Number(n) || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }
    function toNumber(val) {
      if (val === "" || val === null || val === undefined) return 0;
      return Number(val); // inputs type=number j√° entregam ponto como decimal
    }
    function gerarNumeroOrcamento() {
      const d = new Date();
      const pad = (x) => String(x).padStart(2, "0");
      return `ORC${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }

    // ---------- M√°scaras ----------
    function formatarTelefone(input) {
      let v = input.value.replace(/\D/g, "").substring(0, 11);
      input.value = v.length <= 10
        ? v.replace(/(\d{2})(\d{4})(\d{0,4})/, "($1) $2-$3")
        : v.replace(/(\d{2})(\d{5})(\d{0,4})/, "($1) $2-$3");
    }
    function formatarDocumento(input) {
      let v = input.value.replace(/\D/g, "");
      input.value = v.length <= 11
        ? v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, "$1.$2.$3-$4")
        : v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, "$1.$2.$3/$4-$5");
    }

    // ---------- Servi√ßos ----------
    function adicionarServico() {
      const div = document.createElement("div");
      div.className = "servico-group";
      div.innerHTML = `
        <input type="text" class="descricao" placeholder="Descri√ß√£o" />
        <input type="number" class="quantidade" placeholder="Qtd" min="1" value="1" oninput="atualizarTotais()" />
        <input type="number" class="valorUnitario" placeholder="Valor Unit√°rio (R$)" min="0" step="0.01" oninput="atualizarTotais()" />
        <input type="text" class="totalItem right" placeholder="Total (R$)" readonly value="R$ 0,00" />
      `;
      document.getElementById("servicos").appendChild(div);
    }

    function atualizarTotais() {
      let totalGeral = 0;
      document.querySelectorAll(".servico-group").forEach(group => {
        const qtd = toNumber(group.querySelector(".quantidade").value);
        const valorUnit = toNumber(group.querySelector(".valorUnitario").value);
        const total = qtd * valorUnit;
        group.querySelector(".totalItem").value = brl(total);
        totalGeral += total;
      });

      const entrega = document.getElementById("entregaRetirada").value === "Entrega";
      const taxaEntrega = entrega ? toNumber(document.getElementById("taxaEntrega").value) : 0;
      totalGeral += taxaEntrega;

      document.getElementById("valorTotal").value = brl(totalGeral);
    }

    function toggleTaxaEntrega() {
      const entrega = document.getElementById("entregaRetirada").value === "Entrega";
      document.getElementById("taxaEntregaField").style.display = entrega ? "block" : "none";
      atualizarTotais();
    }

    // ---------- Persist√™ncia ----------
    function salvarOrcamento() {
      const numeroOrcamento = document.getElementById("numeroOrcamento").value;
      const cliente = document.getElementById("cliente").value.trim();
      const contato = document.getElementById("contato").value.trim();
      const rua = document.getElementById("rua").value.trim();
      const bairro = document.getElementById("bairro").value.trim();
      const numero = document.getElementById("numero").value.trim();
      const referencia = document.getElementById("referencia").value.trim();
      const endereco = `${rua}, ${numero} - ${bairro}. Ref: ${referencia}`.trim();
      const documento = document.getElementById("documento").value.trim();
      const servicos = [...document.querySelectorAll(".servico-group")].map(group => {
        const descricao = group.querySelector(".descricao").value.trim();
        const quantidade = toNumber(group.querySelector(".quantidade").value);
        const valorUnitario = toNumber(group.querySelector(".valorUnitario").value);
        const total = quantidade * valorUnitario;
        return { descricao, quantidade, valorUnitario, total };
      });
      const descricao = document.getElementById("descricao").value.trim();
      const prazo = document.getElementById("prazo").value;
      const entregaRetirada = document.getElementById("entregaRetirada").value;
      const taxaEntrega = entregaRetirada === "Entrega" ? toNumber(document.getElementById("taxaEntrega").value) : 0;

      const totalGeral = servicos.reduce((acc, s) => acc + s.total, 0) + taxaEntrega;

      if (!numeroOrcamento || !cliente || !contato || !prazo || totalGeral <= 0) {
        alert("Preencha N¬∞ do or√ßamento, cliente, contato, prazo e ao menos 1 item com valor.");
        return;
      }

      const orcamentos = JSON.parse(localStorage.getItem("orcamentos")) || [];
      const id = Date.now();
      orcamentos.push({
        id, numeroOrcamento, cliente, contato, endereco, documento,
        servicos, descricao, prazo, entregaRetirada, taxaEntrega, totalGeral
      });
      localStorage.setItem("orcamentos", JSON.stringify(orcamentos));

      carregarOrcamentos();
      limparCampos();
    }

    function carregarOrcamentos() {
      const orcamentos = JSON.parse(localStorage.getItem("orcamentos")) || [];
      const lista = document.getElementById("listaOrcamentos");
      lista.innerHTML = "";

      orcamentos.forEach(o => {
        const div = document.createElement("div");
        div.className = "orcamento-card";
        div.innerHTML = `
          <p><b>N¬∞ Or√ßamento:</b> ${o.numeroOrcamento}</p>
          <p><b>Cliente:</b> ${o.cliente}</p>
          <p><b>Contato:</b> ${o.contato}</p>
          <p><b>Total Geral:</b> ${brl(o.totalGeral)}</p>
          <button class="btn-pdf" onclick="gerarPDF(${o.id})">üìÑ PDF</button>
          <button class="btn-del" onclick="deletarOrcamento(${o.id})">üóë Excluir</button>
        `;
        lista.appendChild(div);
      });
    }

    function deletarOrcamento(id) {
      let orcamentos = JSON.parse(localStorage.getItem("orcamentos")) || [];
      orcamentos = orcamentos.filter(o => o.id !== id);
      localStorage.setItem("orcamentos", JSON.stringify(orcamentos));
      carregarOrcamentos();
    }

    function limparCampos() {
      document.querySelectorAll("input, textarea").forEach(el => el.value = "");
      document.getElementById("entregaRetirada").value = "Retirada";
      document.getElementById("taxaEntregaField").style.display = "none";
      document.getElementById("servicos").innerHTML = `
        <div class="servico-group">
          <input type="text" class="descricao" placeholder="Descri√ß√£o" />
          <input type="number" class="quantidade" placeholder="Qtd" min="1" value="1" oninput="atualizarTotais()" />
          <input type="number" class="valorUnitario" placeholder="Valor Unit√°rio (R$)" min="0" step="0.01" oninput="atualizarTotais()" />
          <input type="text" class="totalItem right" placeholder="Total (R$)" readonly value="R$ 0,00" />
        </div>
      `;
      document.getElementById("numeroOrcamento").value = gerarNumeroOrcamento();
      document.getElementById("valorTotal").value = brl(0);
    }

    // ---------- PDF ----------
    function gerarPDF(id) {
      const orcamentos = JSON.parse(localStorage.getItem("orcamentos")) || [];
      const o = orcamentos.find(x => x.id === id);
      if (!o) return;

      const doc = new jsPDF({ unit: "mm", format: "a4" });
      let y = 20;

      // doc.addImage("logo_base64_aqui", "PNG", 20, 14, 28, 28); // (opcional)

      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text(`Or√ßamento N¬∫ ${o.numeroOrcamento}`, 200 - 20, y, { align: "right" });
      y += 8;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      doc.text(`Cliente: ${o.cliente}`, 20, y); y += 6;
      doc.text(`Contato: ${o.contato}`, 20, y); y += 6;
      if (o.endereco) { doc.text(`Endere√ßo: ${o.endereco}`, 20, y); y += 6; }
      if (o.documento) { doc.text(`CPF/CNPJ: ${o.documento}`, 20, y); y += 8; }

      // Cabe√ßalho da tabela
      const xDesc = 20, xVU = 120, xQtd = 155, xTotal = 175;
      doc.setFont("helvetica", "bold");
      doc.text("Descri√ß√£o", xDesc, y);
      doc.text("Valor Unit√°rio", xVU, y);
      doc.text("Quantidade", xQtd, y);
      doc.text("Total", xTotal, y);
      y += 2; doc.line(20, y, 190, y); y += 5;
      doc.setFont("helvetica", "normal");

      // Linhas
      o.servicos.forEach(s => {
        const desc = doc.splitTextToSize(s.descricao || "-", 95);
        doc.text(desc, xDesc, y);
        doc.text(brl(s.valorUnitario), xVU, y);
        doc.text(String(s.quantidade), xQtd + 8, y, { align: "right" });
        doc.text(brl(s.total), xTotal, y);

        const lineHeight = 6 * (Array.isArray(desc) ? desc.length : 1);
        y += lineHeight;
      });

      y += 4; doc.line(120, y, 190, y); y += 7;
      doc.setFont("helvetica", "bold");
      doc.text(`Total Geral: ${brl(o.totalGeral)}`, 190, y, { align: "right" });
      doc.setFont("helvetica", "normal");
      y += 10;

      if (o.descricao) { doc.text(`Outras informa√ß√µes: ${o.descricao}`, 20, y); y += 8; }
      doc.text(`Prazo: ${o.prazo} dias √∫teis`, 20, y); y += 6;
      doc.text(`Entrega/Retirada: ${o.entregaRetirada}`, 20, y); y += 6;
      if (o.entregaRetirada === "Entrega" && o.taxaEntrega) {
        doc.text(`Taxa de Entrega: ${brl(o.taxaEntrega)}`, 20, y); y += 6;
      }

      doc.save(`orcamento_${o.cliente}.pdf`);
    }

    // ---------- Init ----------
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("numeroOrcamento").value = gerarNumeroOrcamento();
      carregarOrcamentos();
      atualizarTotais();
    });
  </script>
</body>
</html>
