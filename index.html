<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Or√ßamentos Eleva Print</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 950px; margin: 20px auto; padding: 20px; background: #f9f9f9; color: #333; }
    h2 { text-align: center; color: #00B4D8; margin-bottom: 20px; position: relative; }
    #logo { position: absolute; top: 0; left: 20px; height: 60px; }
    .form-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: bold; color: #333; }
    input, textarea, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    button { margin-top: 15px; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.3s; }
    .btn-add { background: #D0006F; color: white; width: 100%; }
    .btn-add:hover { background: #a80055; }
    .btn-service { background: #FFD500; color: #333; margin-top: 8px; }
    .btn-service:hover { background: #e6c200; }
    .orcamento-card { background: white; border-left: 6px solid #FFD500; padding: 15px; margin: 15px 0; border-radius: 8px; box-shadow: 0 3px 6px rgba(0,0,0,0.08); }
    .orcamento-card p { margin: 5px 0; }
    .btn-pdf { background: #00B4D8; color: white; margin-right: 10px; }
    .btn-del { background: #e74c3c; color: white; }
    .btn-pdf:hover { background: #0088a8; }
    .btn-del:hover { background: #c0392b; }
    h3 { color: #D0006F; }
    #taxaEntregaField { display: none; }
    .servico-group { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
    .servico-group input { margin-top: 0; }
  </style>
</head>
<body>
  <!-- LOGO -->
  <img id="logo" src="logo.png" alt="Logo"> 

  <h2>üìë Or√ßamentos Eleva Print</h2>
  
  <div class="form-card">
    <label>N¬∞ do Or√ßamento:</label>
    <input type="text" id="numeroOrcamento" value="ORC-${Date.now()}" />

    <label>Cliente:</label>
    <input type="text" id="cliente">

    <label>Contato (WhatsApp/Telefone):</label>
    <input type="text" id="contato" maxlength="15" oninput="formatarTelefone(this)">

    <h4>üìç Endere√ßo</h4>
    <label>Rua:</label>
    <input type="text" id="rua">
    <label>Bairro:</label>
    <input type="text" id="bairro">
    <label>N√∫mero:</label>
    <input type="number" id="numero">
    <label>Ponto de Refer√™ncia:</label>
    <input type="text" id="referencia">

    <label>CPF ou CNPJ:</label>
    <input type="text" id="documento" oninput="formatarDocumento(this)">

    <label>Servi√ßos/Produtos:</label>
    <div id="servicos">
      <div class="servico-group">
        <input type="text" class="descricao" placeholder="Descri√ß√£o">
        <input type="number" class="quantidade" placeholder="Qtd" min="1" value="1" oninput="atualizarTotais()">
        <input type="text" class="valorUnitario" placeholder="Valor Unit√°rio" oninput="formatarMoeda(this); atualizarTotais()">
        <input type="text" class="totalItem" placeholder="Total" readonly>
      </div>
    </div>
    <button type="button" class="btn-service" onclick="adicionarServico()">‚ûï Adicionar Servi√ßo</button>

    <label>Descri√ß√£o Adicional:</label>
    <textarea id="descricao"></textarea>

    <label>Prazo (dias √∫teis):</label>
    <input type="number" id="prazo">

    <label>Entrega ou Retirada:</label>
    <select id="entregaRetirada" onchange="toggleTaxaEntrega()">
      <option value="Retirada">Retirada</option>
      <option value="Entrega">Entrega</option>
    </select>

    <div id="taxaEntregaField">
      <label>Taxa de Entrega (R$):</label>
      <input type="text" id="taxaEntrega" value="0" oninput="formatarMoeda(this); atualizarTotais()">
    </div>

    <label><b>Total Geral (R$):</b></label>
    <input type="text" id="valorTotal" readonly>

    <button class="btn-add" onclick="salvarOrcamento()">Salvar Or√ßamento</button>
  </div>

  <h3>üìÇ Or√ßamentos Salvos</h3>
  <div id="listaOrcamentos"></div>

  <script>
    const { jsPDF } = window.jspdf;

    // üì± Formatar telefone
    function formatarTelefone(input) {
      let v = input.value.replace(/\D/g, "").substring(0, 11);
      if (v.length <= 10) {
        input.value = v.replace(/(\\d{2})(\\d{4})(\\d{0,4})/, "($1) $2-$3");
      } else {
        input.value = v.replace(/(\\d{2})(\\d{5})(\\d{0,4})/, "($1) $2-$3");
      }
    }

    // üßæ Formatar CPF/CNPJ
    function formatarDocumento(input) {
      let v = input.value.replace(/\\D/g, "");
      if (v.length <= 11) {
        input.value = v.replace(/(\\d{3})(\\d{3})(\\d{3})(\\d{0,2})/, "$1.$2.$3-$4");
      } else {
        input.value = v.replace(/(\\d{2})(\\d{3})(\\d{3})(\\d{4})(\\d{0,2})/, "$1.$2.$3/$4-$5");
      }
    }

    // üí∞ Formatar moeda BRL
    function formatarMoeda(input) {
      let v = input.value.replace(/\\D/g, "");
      if (!v) { input.value = ""; return; }
      v = (v/100).toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
      input.value = v;
    }

    // ‚ûï Adicionar servi√ßo extra
    function adicionarServico() {
      let div = document.createElement("div");
      div.className = "servico-group";
      div.innerHTML = `
        <input type="text" class="descricao" placeholder="Descri√ß√£o">
        <input type="number" class="quantidade" placeholder="Qtd" min="1" value="1" oninput="atualizarTotais()">
        <input type="text" class="valorUnitario" placeholder="Valor Unit√°rio" oninput="formatarMoeda(this); atualizarTotais()">
        <input type="text" class="totalItem" placeholder="Total" readonly>
      `;
      document.getElementById("servicos").appendChild(div);
    }

    // üîÑ Atualizar totais
    function atualizarTotais() {
      let totalGeral = 0;
      document.querySelectorAll(".servico-group").forEach(group => {
        const qtd = parseInt(group.querySelector(".quantidade").value) || 0;
        const valorUnit = parseFloat(group.querySelector(".valorUnitario").value.replace(/[^0-9,-]+/g,"").replace(",",".") || 0);
        const total = qtd * valorUnit;
        group.querySelector(".totalItem").value = total.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
        totalGeral += total;
      });

      const taxaEntrega = document.getElementById("entregaRetirada").value === "Entrega"
        ? parseFloat(document.getElementById("taxaEntrega").value.replace(/[^0-9,-]+/g,"").replace(",",".") || 0)
        : 0;

      totalGeral += taxaEntrega;
      document.getElementById("valorTotal").value = totalGeral.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
    }

    function toggleTaxaEntrega() {
      const entrega = document.getElementById("entregaRetirada").value;
      document.getElementById("taxaEntregaField").style.display = entrega === "Entrega" ? "block" : "none";
      atualizarTotais();
    }

    // üíæ Salvar or√ßamento
    function salvarOrcamento() {
      const numeroOrcamento = document.getElementById("numeroOrcamento").value;
      const cliente = document.getElementById("cliente").value;
      const contato = document.getElementById("contato").value;
      const rua = document.getElementById("rua").value;
      const bairro = document.getElementById("bairro").value;
      const numero = document.getElementById("numero").value;
      const referencia = document.getElementById("referencia").value;
      const endereco = `${rua}, ${numero} - ${bairro}. Ref: ${referencia}`;
      const documento = document.getElementById("documento").value;
      const servicos = [...document.querySelectorAll(".servico-group")].map(group => ({
        descricao: group.querySelector(".descricao").value,
        quantidade: group.querySelector(".quantidade").value,
        valorUnitario: group.querySelector(".valorUnitario").value,
        total: group.querySelector(".totalItem").value
      }));
      const descricao = document.getElementById("descricao").value;
      const prazo = document.getElementById("prazo").value;
      const entregaRetirada = document.getElementById("entregaRetirada").value;
      const taxaEntrega = entregaRetirada === "Entrega" ? document.getElementById("taxaEntrega").value : "R$ 0,00";
      const valorTotal = document.getElementById("valorTotal").value;

      if (!cliente || !contato || !valorTotal || !prazo) {
        alert("Preencha todos os campos obrigat√≥rios!");
        return;
      }

      const orcamentos = JSON.parse(localStorage.getItem("orcamentos")) || [];
      const id = Date.now();
      orcamentos.push({ id, numeroOrcamento, cliente, contato, endereco, documento, servicos, descricao, prazo, entregaRetirada, taxaEntrega, valorTotal });
      localStorage.setItem("orcamentos", JSON.stringify(orcamentos));

      carregarOrcamentos();
      limparCampos();
    }

    // üìÑ Gerar PDF
    function gerarPDF(id) {
      const orcamentos = JSON.parse(localStorage.getItem("orcamentos")) || [];
      const o = orcamentos.find(x => x.id === id);

      const doc = new jsPDF();
      let y = 20;

      // Logo (precisa ser em base64 para aparecer no PDF real)
      // doc.addImage("logo.png", "PNG", 15, y, 30, 30);

      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text(`Or√ßamento N¬∫ ${o.numeroOrcamento}`, 105, y, { align: "center" }); 
      y += 10;

      doc.setFontSize(12);
      doc.text(`Cliente: ${o.cliente}`, 20, y); y += 6;
      doc.text(`Contato: ${o.contato}`, 20, y); y += 6;
      doc.text(`Endere√ßo: ${o.endereco}`, 20, y); y += 6;
      doc.text(`CPF/CNPJ: ${o.documento}`, 20, y); y += 10;

      // Cabe√ßalho da tabela
      doc.setFontSize(12);
      doc.text("Descri√ß√£o", 20, y);
      doc.text("Valor Unit√°rio", 95, y);
      doc.text("Qtd", 140, y);
      doc.text("Total", 170, y);
      y += 6;
      doc.line(20, y, 190, y); 
      y += 4;

      // Linhas da tabela
      o.servicos.forEach(s => {
        doc.text(s.descricao, 20, y);
        doc.text(s.valorUnitario, 95, y);
        doc.text(s.quantidade, 145, y);
        doc.text(s.total, 170, y);
        y += 6;
      });

      y += 6;
      doc.setFontSize(12);
      doc.text(`Total Geral: ${o.valorTotal}`, 150, y, { align: "right" }); 
      y += 10;

      if (o.descricao) {
        doc.text(`Descri√ß√£o adicional: ${o.descricao}`, 20, y); y += 8;
      }

      doc.text(`Prazo: ${o.prazo} dias √∫teis`, 20, y); y += 6;
      doc.text(`Entrega/Retirada: ${o.entregaRetirada}`, 20, y); y += 6;
      if (o.entregaRetirada === "Entrega") {
        doc.text(`Taxa de Entrega: ${o.taxaEntrega}`, 20, y); y += 6;
      }

      doc.save(`orcamento_${o.cliente}.pdf`);
    }

    function carregarOrcamentos() {
      const orcamentos = JSON.parse(localStorage.getItem("orcamentos")) || [];
      const lista = document.getElementById("listaOrcamentos");
      lista.innerHTML = "";

      orcamentos.forEach(o => {
        const div = document.createElement("div");
        div.className = "orcamento-card";
        div.innerHTML = `
          <p><b>N¬∞ Or√ßamento:</b> ${o.numeroOrcamento}</p>
          <p><b>Cliente:</b> ${o.cliente}</p>
          <p><b>Contato:</b> ${o.contato}</p>
          <p><b>Endere√ßo:</b> ${o.endereco}</p>
          <p><b>CPF/CNPJ:</b> ${o.documento}</p>
          <p><b>Total Geral:</b> ${o.valorTotal}</p>
          <button class="btn-pdf" onclick="gerarPDF(${o.id})">üìÑ PDF</button>
          <button class="btn-del" onclick="deletarOrcamento(${o.id})">üóë Excluir</button>
        `;
        lista.appendChild(div);
      });
    }

    function deletarOrcamento(id) {
      let orcamentos = JSON.parse(localStorage.getItem("orcamentos")) || [];
      orcamentos = orcamentos.filter(o => o.id !== id);
      localStorage.setItem("orcamentos", JSON.stringify(orcamentos));
      carregarOrcamentos();
    }

    function limparCampos() {
      document.querySelectorAll("input, textarea").forEach(el => el.value = "");
      document.getElementById("entregaRetirada").value = "Retirada";
      document.getElementById("servicos").innerHTML = `
        <div class="servico-group">
          <input type="text" class="descricao" placeholder="Descri√ß√£o">
          <input type="number" class="quantidade" placeholder="Qtd" min="1" value="1" oninput="atualizarTotais()">
          <input type="text" class="valorUnitario" placeholder="Valor Unit√°rio" oninput="formatarMoeda(this); atualizarTotais()">
          <input type="text" class="totalItem" placeholder="Total" readonly>
        </div>
      `;
      toggleTaxaEntrega();
    }

    carregarOrcamentos();
  </script>
</body>
</html>
